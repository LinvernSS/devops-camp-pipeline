pipeline {
    agent {
        label 'jenkins-agent'
    }
    environment {
	PIPELINE_HASH = sh(script: 'git rev-parse --short HEAD', returnStdout: true).trim()
	HARBOR_REGISTRY = 'harbor.dev.afsmtddso.com'
	HARBOR_PROJECT = 'jxu-devsecops'
	APP_IMAGE_NAME = 'app'
	APP_CONTAINER_NAME = 'jxu-web-app'
	DB_CONTAINER_NAME = 'jxu-postgres-db'
	NETWORK = 'jxu-feature-tests'
	LOG_FILE_NAME = 'jxu_log_file.txt'
    }
    stages {
        stage('Application repository') {
            steps {
                echo "Cloning application repository"
                sh 'git clone https://github.com/xu-june/afs-labs-student.git'
		dir('afs-labs-student') {
			script{
				env.APP_HASH = sh(script: 'git rev-parse --short HEAD', returnStdout: true).trim()
			}
		}
            }
        }
        stage('Application docker build') {
            steps {
                echo "Building application image"
		withCredentials([usernameColonPassword(credentialsId: 'jxu-harbor-auth', variable: 'HARBOR-AUTH')]) {
			script {
				docker.build('$APP_IMAGE_NAME-$APP_HASH', '-f ./app/Dockerfile ./afs-labs-student')
				docker.withRegistry('https://$HARBOR_REGISTRY', 'jxu-harbor-auth') {
					sh 'docker tag $APP_IMAGE_NAME-$APP_HASH $HARBOR_REGISTRY/$HARBOR_PROJECT/$APP_IMAGE_NAME:$APP_HASH-$PIPELINE_HASH'
					sh 'docker push $HARBOR_REGISTRY/$HARBOR_PROJECT/$APP_IMAGE_NAME:$APP_HASH-$PIPELINE_HASH'
				}
			}
		}
	    }
	    post {
		always {
			echo "Clean local $APP_IMAGE_NAME image"
			script {
				try {
					sh 'docker rmi $APP_IMAGE_NAME-$APP_HASH:latest'
					sh 'docker rmi $HARBOR_REGISTRY/$HARBOR_PROJECT/$APP_IMAGE_NAME:$APP_HASH-$PIPELINE_HASH'
				} catch (err) {
					echo err.getMessage()
				}
			}
		}
	    }
        }
	stage('Security scanning') {
		steps {
			withCredentials([usernamePassword(credentialsId: 'jxu-harbor-auth', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD')]) {
			echo "Scanning $APP_IMAGE_NAME image"
			sh 'python harbor_scanner.py -i $APP_IMAGE_NAME -r $HARBOR_REGISTRY -p $HARBOR_PROJECT -c ${USERNAME}:${PASSWORD}'
			}
		}
	}
        stage('Test'){
            steps {
                echo "Testing stage"
    		sh 'docker network create $NETWORK'
		withCredentials([usernamePassword(credentialsId: 'db-auth', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD')]) {
		    	sh """
    			docker run -d --name "$DB_CONTAINER_NAME" \
    			-p "5432:5432" \
    			-e "POSTGRES_USER=${USERNAME}" \
    			-e "POSTGRES_PASSWORD=${PASSWORD}" \
    			-e "POSTGRES_DB=shop" \
    			--network "$NETWORK" \
    			postgres:9.6
    			"""
    			sh """
    			docker run -d --name "$APP_CONTAINER_NAME" \
    			-p "5000:5000" \
    			-e "POSTGRES_USER=${USERNAME}" \
    			-e "POSTGRES_PASSWORD=${PASSWORD}" \
    			-e "DB_CONTAINER_NAME=$DB_CONTAINER_NAME" \
    			-e "LOCATION_FEATURE_ENABLED=True" \
    			--network "$NETWORK" \
    			$HARBOR_REGISTRY/$HARBOR_REPOSITORY/$APP_IMAGE_NAME:$APP_HASH-$PIPELINE_HASH
    			"""
		}

		script {
			try {
        			sh 'sleep 5 && docker exec $APP_CONTAINER_NAME python tests.py'
    			} catch(Exception e) {
        			sh 'docker cp $APP_CONTAINER_NAME:../farm-to-front-door/log_file.txt $LOG_FILE_NAME'
        			sh 'echo $(cat $LOG_FILE_NAME)'
        			sh 'rm -rf $LOG_FILE_NAME'
        		error('Tests Failed with error ' + e)
    			}
    			sh 'docker cp $APP_CONTAINER_NAME:../farm-to-front-door/log_file.txt $LOG_FILE_NAME'
    			sh 'echo $(cat $LOG_FILE_NAME)'
    			sh 'rm -rf $LOG_FILE_NAME'
		}

		post {
			always {
        			echo "Clean up local docker containers"
        			script {
            				try {
               					sh 'docker rm -f $DB_CONTAINER_NAME'
                				sh 'docker rm -f $APP_CONTAINER_NAME'
                				sh 'docker network rm $NETWORK'
            				} catch (err) {
                				echo err.getMessage()
            				}
        			}
    			}
		}

    	    }
        }
        stage('Deploy') {
            steps {
                echo "Deployment stage"
		sh 'kubectl -n jxu set image deployment/app-deployment app-deployment=$HARBOR_REGISTRY/$HARBOR_PROJECT/$APP_IMAGE_NAME:$APP_HASH-$PIPELINE_HASH'
		sh 'kubectl -n jxu apply -f ./afs-labs-student/kubernetes/config-map.yaml'

            }
        }
    }
    post {
        cleanup {
            echo "Clean workspace"
		sh 'docker system prune -f'
		sh 'rm -rf .git ./*'
        
	}
    }
}

// comment to trigger another build??????
